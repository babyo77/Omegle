let socket=io(),peer,call,YourID;navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280,max:1920,min:640,auto:!0},height:{ideal:720,max:1080,min:360,auto:!0},frameRate:{ideal:30,max:60,auto:!0}},audio:{autoGainControl:!1,noiseSuppression:!1,echoCancellation:!1,sampleRate:44100,channelCount:2}}).then(e=>{You.srcObject=e,localStream=e,console.log("takes"),socket.emit("mediaTaken")}).catch(e=>{console.error("Error accessing media devices:",e)}),socket.on("peer",()=>{(peer=new Peer(void 0,{path:"/peerjs",host:"/",port:"443",config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},]}})).on("open",e=>{YourID=e,console.log("YOUR ID",YourID),socket.emit("connected"),ok()}),peer.on("error",()=>{alert("Server is Down"),window.open("https://instagram.com/babyo7_?utm_source=qr")})});let localStream,RemoteID,connectionstatus=document.getElementById("connection-status"),Chat=document.getElementById("chat"),ChatDiv=document.getElementById("Chatsection"),messageInput=document.getElementById("message"),stranger=document.getElementById("stranger"),You=document.getElementById("you"),paired=!1,nextcall=!0,TypinStatus=!1;function color(e){connectionstatus.classList.remove("text-red-500","text-green-500"),e?connectionstatus.classList.add("text-red-500"):connectionstatus.classList.add("text-green-500")}function findNextRoom(){stranger.srcObject=null,stranger.muted=!0,paired=!1,call.close(),socket.emit("next"),console.log("next")}function createMessage(e,t,n){let o=document.createElement("p");o.textContent=`${e}: ${t}`,o.id=n||"message","Disconnected❗"==t?(o.textContent=t,paired=!1):"Stranger"==e&&o.classList.add("text-red-500"),Chat.append(o),scrollToBottom()}function sendMessage(){"Disconnected ❗"!=messageInput.value&&"Stranger left The Chat"!=messageInput.value&&messageInput.value.trim()&&!0===paired&&(socket.emit("message",messageInput.value),createMessage("You",messageInput.value),messageInput.value="",scrollToBottom())}function scrollToBottom(){ChatDiv.scrollTop=ChatDiv.scrollHeight}function ok(){peer.on("call",e=>{e.answer(localStream),e.on("stream",e=>{stranger.srcObject=e})})}function makeCall(){(call=peer.call(RemoteID,localStream)).on("stream",e=>{stranger.srcObject=e,stranger.muted=!1,console.log("call accepted from",RemoteID)}),call.on("end",()=>{console.log("call ended")}),call.on("error",function(e){console.error(e),stranger.srcObject=null,socket.emit("message","Disconnected ❗"),Chat.innerHTML=""})}socket.on("connected",()=>{connectionstatus.classList=[],color(""),connectionstatus.textContent="Finding Partner \uD83D\uDD0E"}),socket.on("paired",e=>{color(""),connectionstatus.textContent=e,paired=!0,Chat.innerHTML="",setTimeout(()=>{nextcall?(socket.emit("calling",YourID),console.log(YourID),console.log("next call")):(socket.emit("calling",YourID),console.log(YourID),nextcall=!0)},1e3)}),window.onbeforeunload=()=>{call&&call.open&&call.close(),socket.emit("message","Disconnected ❗"),Chat.innerHTML=""},socket.on("pairing",e=>{connectionstatus.textContent=e,Chat.innerHTML="",paired=!1}),socket.on("message:recieved",e=>{paired=!0,"Chat Disconnected❗"==connectionstatus.textContent&&(Chat.innerHTML="",connectionstatus.textContent="Partner Found \uD83E\uDD84 - Chat Connected");let t=document.querySelectorAll("#typing");t.forEach(e=>{t&&t.forEach(t=>{e.remove()})}),color(""),"Stranger left The Chat"==e||"Disconnected ❗"==e?(connectionstatus.textContent="Chat Disconnected❗",color("ok"),createMessage("Stranger","Stranger left The Chat"),stranger.srcObject=null,stranger.muted=!0,paired=!1,scrollToBottom()):(createMessage("Stranger",e),scrollToBottom())}),messageInput.addEventListener("keydown",e=>{"Enter"==e.key&&sendMessage()}),document.addEventListener("keydown",e=>{"Escape"==e.key&&findNextRoom()}),messageInput.addEventListener("input",()=>{TypinStatus||(TypinStatus=!0,socket.emit("typing"),scrollToBottom()),setTimeout(()=>{TypinStatus=!1;let e=document.querySelectorAll("#typing");e.forEach(t=>{e&&e.forEach(e=>{e.remove()})})},1300)}),socket.on("typing",()=>{TypinStatus||(createMessage("Stranger","Typing..","typing"),TypinStatus=!0,scrollToBottom()),setTimeout(()=>{TypinStatus=!1;let e=document.querySelectorAll("#typing");e&&e.forEach(e=>{e.remove()})},1300)}),socket.on("call-Accepted",e=>{RemoteID=e,console.log("incoming call",e),makeCall()});